#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

BUILD_DIR=$1
CACHE_DIR=$2

COMPRESSED_PACKAGE="$CACHE_DIR/wkhtmltox-0.12.3_linux-generic-amd64.tar.xz"
TS=`date +%s`
if [ ! -f $COMPRESSED_PACKAGE ]; then
  WKHTMLTOPDF_DOWNLOAD_URL="http://download.gna.org/wkhtmltopdf/0.12/0.12.3/wkhtmltox-0.12.3_linux-generic-amd64.tar.xz"
  echo "-----> Downloading wkhtmltopdf: $WKHTMLTOPDF_DOWNLOAD_URL"
  curl -L -o $COMPRESSED_PACKAGE $WKHTMLTOPDF_DOWNLOAD_URL
fi

echo "-----> Installing wkhtmltopdf 0.12.3"
mkdir -p "$BUILD_DIR/.custom_packages"
tar xvfJ "$COMPRESSED_PACKAGE" "$BUILD_DIR/.custom_packages/"

echo "Writing profile script" | indent
mkdir -p "$BUILD_DIR/.profile.d"
cat <<EOF >"$BUILD_DIR/.profile.d/wkhtmltopdf.sh"
export PATH="\$HOME/.custom_packages/wkhtmltox/bin:\$PATH"
export LD_LIBRARY_PATH="\$HOME/.custom_packages/wkhtmltox/lib:\$LD_LIBRARY_PATH"
export LIBRARY_PATH="\$HOME/.custom_packages/wkhtmltox/lib:\$LIBRARY_PATH"
export INCLUDE_PATH="\$HOME/.custom_packages/wkhtmltox/include/wkhtmltox:\$INCLUDE_PATH"
export CPATH="\$INCLUDE_PATH"
export CPPPATH="\$INCLUDE_PATH"
export WKHTMLTOPDF_CMD="\$HOME/.custom_packages/wkhtmltox/bin/wkhtmltopdf"
export WKHTMLTOIMAGE_CMD="\$HOME/.custom_packages/wkhtmltox/bin/wkhtmltoimage"
EOF
chmod +x "$BUILD_DIR/.custom_packages/wkhtmltox/bin"
